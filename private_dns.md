### bind9으로 사설망 DNS 구축하기

---
내부 DNS 구축을 위하여 정리한 글입니다.

#### 설치 및 테스트 환경  
> Machine: Raspberry Pi 4  
> OS: ubuntu 16.04 server   
> Domain: oiio.home   
> DNS server: 192.168.1.26  
> desk PC: 192.168.1.22  
> 공유기: ipTime A604  

#### Bind9 설치
```
$ sudo apt-get install -y bind9
```
새로 구축한 DNS가 ISP의 DNS를 포워딩할 수 있게 /etc/bind/named.conf.options를 다음과 같이 수정합니다.
```
forwarders {
    // KT DNS
    168.126.63.1;
    168.126.63.2;
    // Google DNS
    8.8.8.8;
    8.8.4.4;
};
```

#### Zone File 생성
하나의 domain name이 해당하는 단위를 zone이라고 칭합니다. zone 단위로 설정이 가능하며 해당 zone에 대한 상세 설정을 명시하기 위해 다음과 같이 /etc/bind/named.conf.local에 추가합니다.

```
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

zone "1.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/db.1.168.192";
};

zone "oiio.home" {
    type master;
    file "/etc/bind/db.oiio.home";
};
```
##### db.1.168.192 파일 생성
/etc/bind/ 로 이동하여 db.1.168.192 파일을 다음과 같이 작성합니다.  
```
$ sudo cp /etc/bind/db.local /etc/bind/db.1.168.192
$ sudo vim /etc/bind/db.1.168.192
```
```
;
; BIND data file for local loopback interface
;
$TTL    604800
@       IN      SOA     ns.oiio.home. admin.oiio.home. (
                              2         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
@       IN      NS      ns.oiio.home.


;private hosts, reverse lookup
26      IN      PTR     ns.oiio.home.

22      IN      PTR     desk.oiio.home.
```

##### db.oiio.home 파일 생성
/etc/bind/ 로 이동하여 db.oiio.home 파일을 다음과 같이 작성합니다.  
```
$ sudo cp /etc/bind/db.local /etc/bind/db.oiio.home
$ sudo vim /etc/bind/db.oiio.home
```
```
;
; BIND data file for local loopback interface
;
$TTL    604800
@       IN      SOA     ns.oiio.home. admin.oiio.home. (
                              2         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
@       IN      NS      localhost.
@       IN      A       127.0.0.1
@       IN      AAAA    ::1

;private hosts
ns      IN      A       192.168.1.26

;also desktop
desk    IN      A       192.168.1.22
```

##### 오류 체크
```
$ sudo named-checkconf
$ sudo named-checkzone oiio.home /etc/bind/db.oiio.home
sudo: unable to resolve host ubuntu
zone oiio.home/IN: loaded serial 2
OK
```

##### bind9 재구동
```
$ sudo service bind9 restart
```

##### 간이 DNS 서버 테스트
다음과 같이 하면, 제대로 적용이 되었는지 간이로 테스트 해볼 수 있다.  
(resolv.con 파일은 재부팅하면 다시 생성된다.)
```
sudo vim /etc/resolv.conf
```
```
nameserver 192.168.1.26
search oiio.home.

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 1.214.68.2
nameserver 61.41.153.2
```

테스트
```
$ nslookup www.daum.net
Server:         1.214.68.2
Address:        1.214.68.2#53

Non-authoritative answer:
www.daum.net    canonical name = www.g.daum.net.
Name:   www.g.daum.net
Address: 203.133.167.81
Name:   www.g.daum.net
Address: 211.231.99.17

$ nslookup desk.oiio.home
Server:         192.168.1.26
Address:        192.168.1.26#53

Name:   desk.oiio.home
Address: 192.168.1.22

ubuntu@ubuntu:/etc/bind$
```

#### 공유기 내 DNS 설정
대다수의 PC환경은 DHCP를 통해 동적 IP주소를 할당받는 형태이고 DHCP를 통해 DNS도 자동으로 받아오게 됩니다. iptime 기준으로 다음과 같은 설정으로 클라이언트에서 위에서 구축한 DNS를 활용할 수 있습니다.  

![](/assets/iptime_private_dns.png)

* ipTime 설정 저장 후, 각 PC들을 재부팅해야 새로운 DNS 서버 설정 정보가 반영됩니다.
